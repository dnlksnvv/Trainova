# Тестирование Workout Service

В этом документе описаны тесты для сервиса управления тренировками (Workout Service) и инструкции по их запуску.

## Структура тестов

Тесты организованы следующим образом:

- `test_exercises_service.py` - юнит-тесты для сервиса упражнений
- `test_training_service.py` - юнит-тесты для сервиса тренировок
- `test_api.py` - тесты для API маршрутов (через имитацию HTTP-запросов)
- `test_api_simple.py` - тесты для API маршрутов (напрямую через методы роутера)
- `test_database.py` - тесты для работы с базой данных

## Описание тестовых файлов

### test_database.py
Тестирует работу с базой данных через мок, имитирующий реальную базу данных:

- `test_database_connection` - проверяет подключение к базе данных и выполнение простого запроса SELECT 1
- `test_get_exercises_table_exists` - проверяет существование таблицы exercises
- `test_get_muscle_groups_table_exists` - проверяет существование таблицы muscle_groups
- `test_fetch_exercises` - проверяет получение всех упражнений из базы данных
- `test_fetch_exercise_by_id` - проверяет получение упражнения по ID

### test_exercises_service.py
Тестирует логику сервиса упражнений:

- `test_get_all_exercises` - проверяет получение всех упражнений
- `test_get_exercise_by_id` - проверяет получение упражнения по ID
- `test_create_exercise` - проверяет создание нового упражнения
- `test_update_exercise` - проверяет обновление существующего упражнения
- `test_delete_exercise` - проверяет удаление упражнения

### test_training_service.py
Тестирует логику сервиса тренировок:

- `test_get_trainings` - проверяет получение списка всех тренировок
- `test_get_training_by_id` - проверяет получение тренировки по ID

### test_api.py
Тестирует API через имитацию HTTP-запросов и проверку ответов:

- `test_read_root` - проверяет ответ от корневого маршрута API
- `test_get_exercises_unauthorized` - проверяет поведение API при неавторизованном доступе
- `test_get_exercises_authorized` - проверяет получение списка упражнений авторизованным пользователем
- `test_get_exercise_by_id_authorized` - проверяет получение упражнения по ID авторизованным пользователем
- `test_get_muscle_groups_authorized` - проверяет получение списка групп мышц авторизованным пользователем

### test_api_simple.py
Тестирует методы API роутера напрямую, без HTTP-контекста:

- `test_get_exercises` - проверяет метод получения всех упражнений
- `test_get_exercise_by_id` - проверяет метод получения упражнения по ID
- `test_get_muscle_groups` - проверяет метод получения всех групп мышц

## Различия между тестами API

Мы используем два подхода к тестированию API:

1. **test_api.py** - имитирует HTTP-запросы и проверяет полные ответы, включая статус коды и заголовки. Этот подход ближе к реальному использованию API и позволяет тестировать middleware, авторизацию и другие аспекты веб-приложения.

2. **test_api_simple.py** - вызывает методы роутера напрямую, обходя HTTP-уровень. Это дает более простое и быстрое тестирование логики роутера без зависимостей от FastAPI. Полезно при проблемах с зависимостями или для изоляции проблем в логике роутера.

## Типы тестов

### Юнит-тесты

Юнит-тесты проверяют отдельные компоненты приложения в изоляции, используя моки для замены внешних зависимостей. Эти тесты быстрые и не требуют подключения к базе данных или другим внешним сервисам.

### Интеграционные тесты

В нашем проекте интеграционные тесты реализованы через моки, эмулирующие поведение внешних зависимостей. Это позволяет проверять взаимодействие компонентов без реальных внешних сервисов.

## Запуск тестов

### Подготовка окружения

1. Убедитесь, что у вас установлен Python 3.8+
2. Установите зависимости:
   ```
   pip install -r requirements.txt
   ```

### Запуск через pytest напрямую

Вы можете запустить тесты напрямую с помощью pytest:

```bash
# Запуск всех тестов
python -m pytest tests/

# Запуск конкретного файла с тестами
python -m pytest tests/test_exercises_service.py

# Запуск с подробным выводом
python -m pytest tests/ -v
```

## Возможные проблемы и решения

### 1. Проблемы с TestClient для FastAPI

В файле `test_api.py` используются асинхронные тесты с AsyncClient вместо синхронного TestClient из-за проблем совместимости версий FastAPI и его зависимостей. Если вы столкнетесь с ошибкой `TypeError: Client.__init__() got an unexpected keyword argument 'app'`, используйте простые тесты из `test_api_simple.py`.

### 2. Проблемы с сравнением UUID объектов

При сравнении UUID объектов в тестах используйте преобразование к строкам:

```python
# Неправильно
assert result.exercise_id == TEST_EXERCISE_ID

# Правильно
assert str(result.exercise_id) == str(TEST_EXERCISE_ID)
```

### 3. Ошибки с AsyncMock для await

При мокировании асинхронных методов убедитесь, что все необходимые методы объявлены как AsyncMock:

```python
db_instance.fetch = AsyncMock()
db_instance.fetchrow = AsyncMock()
db_instance.execute = AsyncMock()
db_instance.fetchval = AsyncMock()
```

## Написание новых тестов

При написании новых тестов следуйте этим рекомендациям:

1. Юнит-тесты должны тестировать только один компонент за раз
2. Используйте моки для внешних зависимостей в юнит-тестах
3. Используйте фикстуры для настройки и очистки тестового окружения
4. Для тестов API предпочитайте прямое тестирование методов без использования FastAPI/Starlette компонентов

## Тесты базы данных

Тесты базы данных используют моки для имитации взаимодействия с базой данных. Это позволяет:

1. Запускать тесты без реальной базы данных
2. Тестировать функциональность в изоляции
3. Выполнять тесты быстрее и надежнее

В методах `test_database_connection`, `test_get_exercises_table_exists` и `test_get_muscle_groups_table_exists` используются моки для проверки основной функциональности доступа к базе данных.

Фикстура `mock_database` создает мок для базы данных, который возвращает предопределенные ответы на запросы, таким образом эмулируя поведение реальной базы данных без фактического подключения.

## Возможные улучшения тестового покрытия

В текущем наборе тестов есть возможности для расширения:

1. **Для service_training.py можно добавить тесты:**
   - Создания тренировки
   - Обновления тренировки
   - Удаления тренировки
   - Получения тренировок пользователя

2. **Для API можно добавить тесты:**
   - Создания, обновления и удаления упражнений через API
   - Получения, создания, обновления и удаления тренировок через API
